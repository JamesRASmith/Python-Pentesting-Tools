## Socket Functions

##Used to create a socket
#sock = socket.socket(socket_family,sockey_type)

##Create a stream socket
#sock = socket.socket (socket.AF_INET, socket.SOCK_STREAM)

#AF_INET
##Socket Family (here Address Family version 4 or IPv4)

#SOCK_STREAM
##Socket type TCP connections

#SOCK_DGRAM
##Socket type UDP connections

#gethostbyname("host")
##Translate a host name to IPv4 address format

#socket.gethostbyname_ex("host")
##Translate a host name to IPv4 address format, extended interface

#socket.getfqdn("8.8.8.8")
##Get the fqdn (fully qualified domain name)

#socket.gethostname()
##Returns the hostname of the machine.

#socket.error
##Exception handling


##Incredibly simple port scanner that simply tells me open and closed ports on
## a network

##Importing all of the required modules for the project
import time
import socket
import subprocess
import sys
from datetime import datetime

def Scanner():
    ##Variable to count number of open ports
    OpenPorts = 0

    ##Firstly, I need to clear the screen from any previous scans
    subprocess.call('cls', shell=True)

    ##Need to obtain an IP address and port range to scan from the user
    RemoteServer = input("Enter the target IP: ")
    LowPort = int(input("Please enter the port number you wish to start the scan at: "))
    HighPort = int(input("Please enter the port number you wish to stop the scan at: "))
    TimeLimit = int(input("Please enter the timeout length (1-5 seconds): "))
    if TimeLimit < 1:
        print("Please input a valid timeout length")
        time.sleep(5)
        ##Clear the screen from any previous scans
        subprocess.call('cls', shell=True)
        Scanner()
    if TimeLimit > 5:
        print("Please input a valid timeout length")
        ##Clear the screen from any previous scans
        time.sleep(5)
        subprocess.call('cls', shell=True)
        Scanner()
    else:

        ####This transaltes a host name to the IPv4 format for the program to understand.
        RemoteServerIP = socket.gethostbyname(RemoteServer)

        ##Something for the user to view what IP is currently being scanned by the
        ## program
        print ("*******************************************")
        print ("* Please wait, scanning IP: ", RemoteServer,"*")
        print ("* Scanning port: ",LowPort, " - ",HighPort, "               *")
        print ("* Timeout: ",TimeLimit, "                            *")
        print ("*******************************************")

        ##Inspiration from Nmap
        ##Check at what time the scan started
        Time = datetime.now()

        ##To start I will set the program to scan ports 1-100 as a test and work from
        ## there

        ##Use a range function to achieve this
        try:
            ##Ports 1 - 1000 are scanned
            for port in range(LowPort,HighPort):
                ##'socket.AF_INET' specifies the connection will use IPv4
                ##'socket.SOCK_STREAM' will use the TCP protocol
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                ##If the prograzm receives no response within the timeout limit then
                ## the program returns that the port is closed
                sock.settimeout(TimeLimit)
                ##Returns the value 0 is the above operation is completed.
                ##This then  triggers the next part of the code
                result = sock.connect_ex((RemoteServerIP, port))
                if result == 0:
                    print("Port {}: Open".format(port))
                    OpenPorts = OpenPorts + 1
                else:
                    print("Port {}: Closed".format(port))
                sock.close()

        ##If the user presses the key combination of 'Ctrl + C' then the scan is stopped
        ## and the following code is executed
        except KeyboardInterrupt:
            print("Stopping scan!")
            ##Check how long the scan has taken
            Time2 = datetime.now()
            ##Calculation for length of scan
            Time = Time2 - Time
            ##Tells the user how long the scan took to complete
            print("Scan Completed in: ",Time)
            ##Number of open ports found
            print("Number of open ports: ",OpenPorts)
            sys.exit()

        ##If the program cannot resolve the IP then the following message is displayed
        except socket.gaierror:
            print("hostname could not be resolved. Exiting")
            sys.exit()

        ##If the program cannot connect to the server then the following message is
        ## displayed
        except socket.error:
            print("Could not connect to server")
            sys.exit()

        ##Check how long the scan has taken
        Time2 = datetime.now()

        ##Calculation for length of scan
        Time = Time2 - Time

        print("Scan Completed in: ",Time)
        time.sleep(3)
        print("Number of open ports: ",OpenPorts)
        print("Press 'Ctrl + C' to exit the program")
        time.sleep(60)
        

Scanner()
